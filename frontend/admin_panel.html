<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - Green Roots</title>
    
    <link rel="stylesheet" href="/frontend/home.css"> 
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        // Función de Protección de Ruta (debe estar al inicio de cada dashboard)
        function protectRoute(allowedRoles) {
            const userDataJSON = localStorage.getItem("usuario");
            const loginPage = "login.html";
            const homePage = "index.html"; // Redirige a la página principal si el rol es incorrecto

            // 1. Si no hay sesión, forzar inicio de sesión
            if (!userDataJSON) {
                window.location.replace(loginPage);
                return false;
            }

            const userData = JSON.parse(userDataJSON);
            const userRol = userData.rol ? userData.rol.toLowerCase() : '';

            // 2. Si el rol NO está permitido, redirigir a la página principal (index.html)
            if (!allowedRoles.includes(userRol)) {
                alert("Acceso denegado. Solo el rol Administrador tiene acceso a este panel.");
                window.location.replace(homePage);
                return false;
            }
            return true;
        }

        // Llama a la función de protección: Solo Administrador
        const isAllowed = protectRoute(['administrador']);
        
        // Si no está permitido, detenemos la ejecución del script aquí
        if (!isAllowed) {
            throw new Error("Acceso no autorizado. Redirección en curso."); 
        }
    </script>
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="logo">
                    <img src="/frontend/Green_Roots.jpg" alt="Green Roots Logo" class="logo-img">
                    <h1>Administrador</h1>
                </div>
                <div class="auth-buttons" style="display: flex; gap: 10px;">
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Inicio</a>
                    <a id="logoutBtn" href="#" class="nav-link logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                </div>
            </div>
        </nav>
    </header>
    
    <main style="padding-top: 100px; padding-bottom: 40px;">
        <div class="container">
            <h2 class="section-title">Gestión Central y Validación de Datos</h2>

            <div class="info-grid">
                <section class="card validation-queue info-card warning">
                    <div class="card-icon" style="background: var(--warning-orange);"><i class="fas fa-check-double"></i></div>
                    <h3>Registros Pendientes de Validación (5)</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Asegure la trazabilidad y transparencia del impacto.</p>
                    <ul id="registrosPendientes" style="list-style: none; padding-left: 0;">
                        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;">
                            <span>Árbol #547 (Juan Pérez)</span>
                            <button class="submit-btn btn-sm btn-approve" data-id="547" style="width: auto; background: var(--success-green);"><i class="fas fa-thumbs-up"></i> Aprobar</button>
                        </li>
                        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;">
                            <span>Evidencia Foto #212 (María L.)</span>
                            <button class="submit-btn btn-sm btn-approve" data-id="212" style="width: auto; background: var(--success-green);"><i class="fas fa-thumbs-up"></i> Aprobar</button>
                        </li>
                        <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0;">
                            <span>Ubicación GPS (Zona X)</span>
                            <button class="submit-btn btn-sm btn-approve" data-id="gps" style="width: auto; background: var(--success-green);"><i class="fas fa-thumbs-up"></i> Aprobar</button>
                        </li>
                    </ul>
                </section>

                <section class="card management-tools info-card">
                    <div class="card-icon"><i class="fas fa-users-cog"></i></div>
                    <h3>Gestión Central de Plataforma</h3>
                    <p style="margin-bottom: 15px; color: var(--text-light);">Control total sobre usuarios, roles y dispositivos IoT.</p>
                    <button class="submit-btn" style="background: var(--primary-green); margin-bottom: 10px;"><i class="fas fa-user-tag"></i> Gestionar Usuarios y Roles</button>
                    <button class="submit-btn" style="background: var(--light-green); margin-bottom: 10px;"><i class="fas fa-bullhorn"></i> Crear/Editar Campañas</button>
                    <button class="submit-btn" style="background: var(--forest-green);"><i class="fas fa-ethernet"></i> Control de Dispositivos IoT</button>
                </section>
            </div>

            <section class="card impact-charts" style="margin-top: 40px; padding: 30px;">
                <h4 class="activity-title">Visualización de Impacto por Comunidad y Especie</h4>
                <div id="graficoEspecies" style="height: 400px; background-color: #f0f0f0; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
                    [Área para Gráficos Dinámicos (Ej: Especies más plantadas, Impacto por Comunidad)]
                </div>
                <p style="text-align: center; color: var(--text-light);"><i class="fas fa-filter"></i> **Filtros:** Comunidad, Especie, Zona Geográfica, Rol</p>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 Green Roots. Panel de Administrador.</p>
            </div>
        </div>
    </footer>

    <script>
        // La variable isAllowed ya está definida en el <head> y garantiza que el usuario es administrador.
        
        // Lógica para el botón de Aprobación
        document.querySelectorAll('.btn-approve').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const itemId = e.currentTarget.getAttribute('data-id');
                // Aquí iría la llamada a la API: fetch(`${API_URL}/validate/${itemId}`, { method: 'POST' });
                alert(`Registro #${itemId} aprobado. Se notificará al voluntario.`);
                // Opcional: remover el elemento de la lista
                e.currentTarget.closest('li').style.display = 'none';
            });
        });

        // Lógica de Cerrar Sesión
        document.getElementById("logoutBtn").addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.clear();
            alert("Has cerrado sesión.");
            window.location.replace("login.html");
        });
    </script>
</body>
</html>
